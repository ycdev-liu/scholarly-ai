version: "3.9"

services:
  # -----------------------
  # PostgreSQL (长期记忆)
  # -----------------------
  postgres:
    image: postgres:16-alpine  # 使用 alpine 版本，更小
    ports:
      - "5432:5432"  # 暴露端口供本地应用连接
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-agent_store}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5
    # 限制日志大小
    logging:
      driver: "json-file"
      options:
        max-size: "5m"      # 减小到 5MB
        max-file: "2"        # 只保留 2 个文件
    # 限制容器资源
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # -----------------------
  # etcd (Milvus metadata)
  # -----------------------
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_RETENTION=1
      - ETCD_QUOTA_BACKEND_BYTES=2147483648  # 减小到 2GB
      - ETCD_HEARTBEAT_INTERVAL=500
      - ETCD_ELECTION_TIMEOUT=2500
    command:
      - etcd
      - --advertise-client-urls=http://0.0.0.0:2379
      - --listen-client-urls=http://0.0.0.0:2379
    ports:
      - "2379:2379"  # 暴露端口供本地应用连接（如果需要）
    volumes:
      - etcd_data:/etcd
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 256M

  # -----------------------
  # MinIO (Milvus segment storage)
  # -----------------------
  minio:
    image: minio/minio:latest
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # MinIO API 端口
      - "9001:9001"  # MinIO Console 端口
    volumes:
      - minio_data:/data
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 512M

  # -----------------------
  # Milvus 向量数据库
  # -----------------------
  milvus:
    image: milvusdb/milvus:latest
    depends_on:
      - etcd
      - minio
    ports:
      - "19530:19530"  # Milvus 服务端口，供本地应用连接
      - "9091:9091"    # Milvus 监控端口
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 2G

# -----------------------
# 持久化卷
# -----------------------
volumes:
  postgres_data:
  milvus_data:
  etcd_data:
  minio_data: